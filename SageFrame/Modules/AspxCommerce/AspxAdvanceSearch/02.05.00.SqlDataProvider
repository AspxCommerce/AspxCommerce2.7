
GO

IF  EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[DF_Aspx_AdvanceSearchSetting_IsActive]') AND type = 'D')
BEGIN
ALTER TABLE [dbo].[Aspx_AdvanceSearchSetting] DROP CONSTRAINT [DF_Aspx_AdvanceSearchSetting_IsActive]
END

GO

IF  EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[DF_Aspx_AdvanceSearchSetting_IsDeleted]') AND type = 'D')
BEGIN
ALTER TABLE [dbo].[Aspx_AdvanceSearchSetting] DROP CONSTRAINT [DF_Aspx_AdvanceSearchSetting_IsDeleted]
END

GO

IF  EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[DF_Aspx_AdvanceSearchSetting_IsModified]') AND type = 'D')
BEGIN
ALTER TABLE [dbo].[Aspx_AdvanceSearchSetting] DROP CONSTRAINT [DF_Aspx_AdvanceSearchSetting_IsModified]
END

GO

IF  EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[DF_Aspx_AdvanceSearchSetting_AddedOn]') AND type = 'D')
BEGIN
ALTER TABLE [dbo].[Aspx_AdvanceSearchSetting] DROP CONSTRAINT [DF_Aspx_AdvanceSearchSetting_AddedOn]
END

GO

IF  EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[DF_Aspx_AdvanceSearchSetting_UpdatedOn]') AND type = 'D')
BEGIN
ALTER TABLE [dbo].[Aspx_AdvanceSearchSetting] DROP CONSTRAINT [DF_Aspx_AdvanceSearchSetting_UpdatedOn]
END

GO


GO

/****** Object:  Table [dbo].[Aspx_AdvanceSearchSetting]    Script Date: 02/19/2014 12:18:15 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Aspx_AdvanceSearchSetting]') AND type in (N'U'))
DROP TABLE [dbo].[Aspx_AdvanceSearchSetting]
GO


GO

/****** Object:  Table [dbo].[Aspx_AdvanceSearchSetting]    Script Date: 02/19/2014 12:18:16 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[Aspx_AdvanceSearchSetting](
	[SettingID] [int] IDENTITY(1,1) NOT NULL,
	[SettingKey] [nvarchar](256) NULL,
	[SettingValue] [nvarchar](256) NULL,
	[StoreID] [int] NULL,
	[PortalID] [int] NULL,
	[CultureName] [nvarchar](256) NULL,
	[IsActive] [bit] NOT NULL,
	[IsDeleted] [bit] NOT NULL,
	[IsModified] [bit] NULL,
	[AddedOn] [datetime] NULL,
	[UpdatedOn] [datetime] NULL,
	[DeletedOn] [datetime] NULL,
	[AddedBy] [nvarchar](256) NULL,
	[UpdatedBy] [nvarchar](256) NULL,
	[DeletedBy] [nvarchar](256) NULL,
 CONSTRAINT [PK_Aspx_AdvanceSearchSetting] PRIMARY KEY CLUSTERED 
(
	[SettingID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]

GO

ALTER TABLE [dbo].[Aspx_AdvanceSearchSetting] ADD  CONSTRAINT [DF_Aspx_AdvanceSearchSetting_IsActive]  DEFAULT ((1)) FOR [IsActive]
GO

ALTER TABLE [dbo].[Aspx_AdvanceSearchSetting] ADD  CONSTRAINT [DF_Aspx_AdvanceSearchSetting_IsDeleted]  DEFAULT ((0)) FOR [IsDeleted]
GO

ALTER TABLE [dbo].[Aspx_AdvanceSearchSetting] ADD  CONSTRAINT [DF_Aspx_AdvanceSearchSetting_IsModified]  DEFAULT ((0)) FOR [IsModified]
GO

ALTER TABLE [dbo].[Aspx_AdvanceSearchSetting] ADD  CONSTRAINT [DF_Aspx_AdvanceSearchSetting_AddedOn]  DEFAULT (getdate()) FOR [AddedOn]
GO

ALTER TABLE [dbo].[Aspx_AdvanceSearchSetting] ADD  CONSTRAINT [DF_Aspx_AdvanceSearchSetting_UpdatedOn]  DEFAULT (getdate()) FOR [UpdatedOn]
GO

GO
/****** Object:  Table [dbo].[Aspx_AdvanceSearchSetting]    Script Date: 02/19/2014 12:20:06 ******/
SET IDENTITY_INSERT [dbo].[Aspx_AdvanceSearchSetting] ON
INSERT [dbo].[Aspx_AdvanceSearchSetting] ([SettingID], [SettingKey], [SettingValue], [StoreID], [PortalID], [CultureName], [IsActive], [IsDeleted], [IsModified], [AddedOn], [UpdatedOn], [DeletedOn], [AddedBy], [UpdatedBy], [DeletedBy]) VALUES (1, N'IsEnableAdvanceSearch', N'True', 0, 1, N'en-US', 1, 0, 0, CAST(0x0000A2D700AF1802 AS DateTime), CAST(0x0000A2D700AF1802 AS DateTime), NULL, NULL, NULL, NULL)
INSERT [dbo].[Aspx_AdvanceSearchSetting] ([SettingID], [SettingKey], [SettingValue], [StoreID], [PortalID], [CultureName], [IsActive], [IsDeleted], [IsModified], [AddedOn], [UpdatedOn], [DeletedOn], [AddedBy], [UpdatedBy], [DeletedBy]) VALUES (2, N'IsEnableBrandSearch', N'True', 0, 1, N'en-US', 1, 0, 0, CAST(0x0000A2D700AF32FC AS DateTime), CAST(0x0000A2D700AF32FC AS DateTime), NULL, NULL, NULL, NULL)
INSERT [dbo].[Aspx_AdvanceSearchSetting] ([SettingID], [SettingKey], [SettingValue], [StoreID], [PortalID], [CultureName], [IsActive], [IsDeleted], [IsModified], [AddedOn], [UpdatedOn], [DeletedOn], [AddedBy], [UpdatedBy], [DeletedBy]) VALUES (3, N'NoOfItemsInARow', N'5', 0, 1, N'en-US', 1, 0, 0, CAST(0x0000A2D700C2D612 AS DateTime), CAST(0x0000A2D700C2D612 AS DateTime), NULL, NULL, NULL, NULL)
INSERT [dbo].[Aspx_AdvanceSearchSetting] ([SettingID], [SettingKey], [SettingValue], [StoreID], [PortalID], [CultureName], [IsActive], [IsDeleted], [IsModified], [AddedOn], [UpdatedOn], [DeletedOn], [AddedBy], [UpdatedBy], [DeletedBy]) VALUES (4, N'AdvanceSearchPageName', N'AdvanceSearch', 0, 1, N'en-US', 1, 0, 0, CAST(0x0000A2D700C2FA40 AS DateTime), CAST(0x0000A2D700C2FA40 AS DateTime), NULL, NULL, NULL, NULL)
SET IDENTITY_INSERT [dbo].[Aspx_AdvanceSearchSetting] OFF


GO


GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSettingsGet]    Script Date: 02/24/2014 12:19:39 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[usp_Aspx_AdvanceSearchSettingsGet]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSettingsGet]
GO


GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSettingsGet]    Script Date: 02/24/2014 12:19:39 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: 19 Feb 2014
-- Description:	<Description,,>
-- =============================================
-- [dbo].[usp_Aspx_AdvanceSearchSettingsGet] 1,1,'en-US'
CREATE PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSettingsGet] (
	@StoreID INT
	,@PortalID INT
	,@CultureName NVARCHAR(256)
	)
AS
BEGIN
	SET NOCOUNT ON;

	IF (
			NOT EXISTS (
				SELECT SettingKey
				FROM dbo.Aspx_AdvanceSearchSetting
				WHERE storeID = @StoreID
					AND PortalID = @PortalID
				)
			)
	BEGIN
		INSERT INTO dbo.Aspx_AdvanceSearchSetting (
			SettingKey
			,SettingValue
			,StoreID
			,PortalID
			,CultureName
			,[IsActive]
			,[IsDeleted]
			,[IsModified]
			,[AddedOn]
			,[UpdatedOn]
			,[DeletedOn]
			,[AddedBy]
			,[UpdatedBy]
			,[DeletedBy]
			)
		SELECT SettingKey
			,SettingValue
			,@StoreID
			,@PortalID
			,@CultureName
			,[IsActive]
			,[IsDeleted]
			,[IsModified]
			,[AddedOn]
			,[UpdatedOn]
			,[DeletedOn]
			,[AddedBy]
			,[UpdatedBy]
			,[DeletedBy]
		FROM dbo.Aspx_AdvanceSearchSetting
		WHERE PortalID = 1
			AND StoreId = 0
	END;

	WITH SettingCTE
	AS (
		SELECT ass.SettingKey
			,ass.SettingValue
		FROM dbo.Aspx_AdvanceSearchSetting ass
		WHERE StoreID = @StoreID
			AND PortalID = @PortalID
		)
		,AdvanceSearchSetting
	AS (
		SELECT * 
		FROM (
			SELECT SettingValue
				,CASE [SettingKey]
					WHEN 'IsEnableAdvanceSearch'
						THEN 'IsEnableAdvanceSearch'
					WHEN 'IsEnableBrandSearch'
						THEN 'IsEnableBrandSearch'
					WHEN 'NoOfItemsInARow'
						THEN 'NoOfItemsInARow'
					WHEN 'AdvanceSearchPageName'
						THEN 'AdvanceSearchPageName'					
					END AS SKey
			FROM SettingCTE
			) DataTable
		pivot(max(SettingValue) FOR Skey IN (
					IsEnableAdvanceSearch,IsEnableBrandSearch,NoOfItemsInARow,AdvanceSearchPageName					
					)) PivotTable
		)
	SELECT *
	FROM AdvanceSearchSetting
END


GO


GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSettingsUpdate]    Script Date: 02/24/2014 12:46:25 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[usp_Aspx_AdvanceSearchSettingsUpdate]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSettingsUpdate]
GO


GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSettingsUpdate]    Script Date: 02/24/2014 12:46:25 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



-- =============================================
-- Author:		<Author,,Name>
-- Create date: 19 Feb 2014
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSettingsUpdate] (
	@StoreID INT
	,@PortalID INT
	,@CultureName NVARCHAR(256)
	,@SettingKeys NVARCHAR(max)
	,@SettingValues NVARCHAR(max)
	)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @tblKey TABLE (
		RowNum INT identity(1, 1)
		,SettingKey NVARCHAR(500)
		)
	DECLARE @tblValue TABLE (
		RowNum INT identity(1, 1)
		,SettingValue NVARCHAR(500)
		)

	INSERT INTO @tblKey
	SELECT rtrim(ltrim(items))
	FROM split(@SettingKeys, '*')

	INSERT INTO @tblValue
	SELECT rtrim(ltrim(items))
	FROM split(@SettingValues, '*')

	DECLARE @counter INT
		,@RowCount INT

	SELECT @RowCount = count(RowNum)
	FROM @tblKey

	SET @counter = 1

	WHILE (
			@counter <= @RowCount
			OR @counter = 1
			)
	BEGIN
		DECLARE @key NVARCHAR(2000)
			,@value NVARCHAR(2000)

		SELECT @key = SettingKey
		FROM @tblKey
		WHERE RowNum = @counter

		SELECT @value = SettingValue
		FROM @tblValue
		WHERE RowNum = @counter

		UPDATE [dbo].Aspx_AdvanceSearchSetting
		SET SettingValue = @value
		WHERE SettingKey = @key
			AND StoreID = @StoreID
			AND PortalID = @PortalID

		SET @counter = @counter + 1
	END
END


GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByDiscount]    Script Date: 02/19/2014 12:28:31 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[usp_Aspx_AdvanceSearchSortByDiscount]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByDiscount]
GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByIsFeatured]    Script Date: 02/19/2014 12:28:31 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[usp_Aspx_AdvanceSearchSortByIsFeatured]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByIsFeatured]
GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByIsSpecial]    Script Date: 02/19/2014 12:28:31 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[usp_Aspx_AdvanceSearchSortByIsSpecial]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByIsSpecial]
GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByItemID]    Script Date: 02/19/2014 12:28:31 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[usp_Aspx_AdvanceSearchSortByItemID]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByItemID]
GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByItemIDDesc]    Script Date: 02/19/2014 12:28:31 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[usp_Aspx_AdvanceSearchSortByItemIDDesc]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByItemIDDesc]
GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByName]    Script Date: 02/19/2014 12:28:31 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[usp_Aspx_AdvanceSearchSortByName]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByName]
GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByPrice]    Script Date: 02/19/2014 12:28:31 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[usp_Aspx_AdvanceSearchSortByPrice]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByPrice]
GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByPriceDesc]    Script Date: 02/19/2014 12:28:31 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[usp_Aspx_AdvanceSearchSortByPriceDesc]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByPriceDesc]
GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByRatedValue]    Script Date: 02/19/2014 12:28:31 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[usp_Aspx_AdvanceSearchSortByRatedValue]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByRatedValue]
GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortBySoldItem]    Script Date: 02/19/2014 12:28:31 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[usp_Aspx_AdvanceSearchSortBySoldItem]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortBySoldItem]
GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByViewCount]    Script Date: 02/19/2014 12:28:31 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[usp_Aspx_AdvanceSearchSortByViewCount]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByViewCount]
GO


GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByDiscount]    Script Date: 02/19/2014 12:28:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- [dbo].[usp_Aspx_AdvanceSearchSortByDiscount] 1,100,NULL,'a',8,NULL,NULL,'',0,1,1,'superuser','en-US'
-- =============================================
CREATE PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByDiscount]
	-- Add the parameters for the stored procedure here
	(
	@offset INT
	,@limit INT
	,@CategoryID INT = NULL
	,@IsGiftCard BIT
	,@SearchText NVARCHAR(1000)
	,@BrandID INT
	,@PriceFrom DECIMAL(16, 4) = NULL
	,@PriceTo DECIMAL(16, 4) = NULL
	,@Attributes NVARCHAR(4000)
	,@RowTotal INT
	,@StoreID INT
	,@PortalID INT
	,@UserName NVARCHAR(256)
	,@CultureName NVARCHAR(256)
	)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @tblFinal TABLE (ItemID INT)

	IF (@Attributes != '')
	BEGIN
		DECLARE @Tbl TABLE (
			RowNum INT identity(1, 1)
			,SQL NVARCHAR(4000)
			);
		DECLARE @SQL NVARCHAR(MAX)
		DECLARE @tblAttributes TABLE (
			RowNum INT IDENTITY(1, 1)
			,Attribute NVARCHAR(1000)
			)

		INSERT INTO @tblAttributes (Attribute)
		SELECT RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
		FROM (
			SELECT field = CAST('<s>' + REPLACE(@Attributes, ',', '</s><s>') + '</s>' AS XML)
			) d
		CROSS APPLY field.nodes('/s') t(p)

		DECLARE @Counter INT
			,@RowCount INT

		SELECT @RowCount = COUNT(RowNum)
			,@Counter = 1
		FROM @tblAttributes

		WHILE @Counter <= @RowCount
			OR @Counter = 1
		BEGIN
			DECLARE @AttributeID NVARCHAR(50)
				,@InputTypeID INT
				,@ValidationTypeID INT
				,@AttributeValue NVARCHAR(4000)

			SELECT @AttributeID = cast([1] AS NVARCHAR(50))
				,@InputTypeID = [2]
				,@ValidationTypeID = [3]
				,@AttributeValue = [4]
			FROM (
				SELECT Attribute = RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
					,rn = ROW_NUMBER() OVER (
						ORDER BY (
								SELECT 1
								)
						)
				FROM (
					SELECT field = CAST('<s>' + REPLACE(Attribute, '@', '</s><s>') + '</s>' AS XML)
					FROM @tblAttributes
					WHERE RowNum = @Counter
					) d
				CROSS APPLY field.nodes('/s') t(p)
				) r
			PIVOT(MAX(Attribute) FOR rn IN (
						[1]
						,[2]
						,[3]
						,[4]
						)) p

			SELECT @SQL = CASE 
					WHEN @InputTypeID = 1
						THEN CASE 
								WHEN @ValidationTypeID = 3
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Decimal
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								WHEN @ValidationTypeID = 5
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Int
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								ELSE 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Nvarchar
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								END
					WHEN @InputTypeID IN (
							5
							,6
							,9
							,10
							,11
							,12
							)
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Options aios LEFT JOIN Aspx_AttributeValues avs ON aios.AttributeID = avs.AttributeID AND avs.AttributeValueID IN (SELECT rtrim(ltrim(items)) FROM split(aios.AttributeValue, '',''))
                  LEFT JOIN [dbo].[Aspx_AttributeValuesAlias] AVA ON avs.AttributeValueID = AVA.AttributeValueID
                  WHERE cast(COALESCE(AVA.[Value], avs.[Value]) AS NVARCHAR) IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND aios.AttributeID =' + @AttributeID + ' AND aios.IsDeleted=0'
					WHEN @InputTypeID = 7
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Decimal 
                  WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
					END

			INSERT INTO @Tbl
			VALUES (@SQL)

			SET @Counter = @Counter + 1
		END

		DECLARE @Counter1 INT
			,@RowCount1 INT
			,@Sql1 NVARCHAR(max)
			,@tId NVARCHAR(50)

		SELECT @RowCount1 = COUNT(RowNum)
			,@Counter1 = 1
		FROM @Tbl

		SELECT @Sql1 = ''

		WHILE @Counter1 <= @RowCount1
			OR @Counter1 = 1
		BEGIN
			IF (@RowCount1 = 1)
			BEGIN
				SELECT @Sql1 = SQL
				FROM @Tbl
				WHERE RowNum = @Counter1
			END
			ELSE
			BEGIN
				IF (@Counter1 = 1)
				BEGIN
					SELECT @Sql1 = ' SELECT t1.ItemID FROM ( ' + @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' inner join ('
					FROM @Tbl
					WHERE RowNum = @Counter1
				END
				ELSE
				BEGIN
					IF (@Counter1 = @RowCount1)
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID'
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
					ELSE
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID' + ' inner join ('
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
				END

				SELECT @tId = 't' + CAST(@Counter1 AS VARCHAR);
			END

			SET @Counter1 = @Counter1 + 1
		END

		INSERT INTO @tblFinal
		EXEC (@Sql1)
	END;

	IF (@CategoryID IS NULL)
	BEGIN
		IF (@BrandID = 0)
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN dbo.Aspx_Currency c ON i.CurrencyCode = c.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.TotalDiscount DESC
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
		ELSE
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.TotalDiscount DESC
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
	END
	ELSE
	BEGIN
		IF (@IsGiftCard = 0)
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.TotalDiscount DESC
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.TotalDiscount DESC
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.TotalDiscount DESC
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.TotalDiscount DESC
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
		ELSE
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.TotalDiscount DESC
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.TotalDiscount DESC
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.TotalDiscount DESC
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.TotalDiscount DESC
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
	END
END

GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByIsFeatured]    Script Date: 02/19/2014 12:28:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- [dbo].[usp_Aspx_AdvanceSearchSortByIsFeatured] 1,100,NULL,'a',8,NULL,NULL,'',0,1,1,'superuser','en-US'
-- =============================================
CREATE PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByIsFeatured]
	-- Add the parameters for the stored procedure here
	(
	@offset INT
	,@limit INT
	,@CategoryID INT = NULL
	,@IsGiftCard BIT
	,@SearchText NVARCHAR(1000)
	,@BrandID INT
	,@PriceFrom DECIMAL(16, 4) = NULL
	,@PriceTo DECIMAL(16, 4) = NULL
	,@Attributes NVARCHAR(4000)
	,@RowTotal INT
	,@StoreID INT
	,@PortalID INT
	,@UserName NVARCHAR(256)
	,@CultureName NVARCHAR(256)
	)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @tblFinal TABLE (ItemID INT)

	IF (@Attributes != '')
	BEGIN
		DECLARE @Tbl TABLE (
			RowNum INT identity(1, 1)
			,SQL NVARCHAR(4000)
			);
		DECLARE @SQL NVARCHAR(MAX)
		DECLARE @tblAttributes TABLE (
			RowNum INT IDENTITY(1, 1)
			,Attribute NVARCHAR(1000)
			)

		INSERT INTO @tblAttributes (Attribute)
		SELECT RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
		FROM (
			SELECT field = CAST('<s>' + REPLACE(@Attributes, ',', '</s><s>') + '</s>' AS XML)
			) d
		CROSS APPLY field.nodes('/s') t(p)

		DECLARE @Counter INT
			,@RowCount INT

		SELECT @RowCount = COUNT(RowNum)
			,@Counter = 1
		FROM @tblAttributes

		WHILE @Counter <= @RowCount
			OR @Counter = 1
		BEGIN
			DECLARE @AttributeID NVARCHAR(50)
				,@InputTypeID INT
				,@ValidationTypeID INT
				,@AttributeValue NVARCHAR(4000)

			SELECT @AttributeID = cast([1] AS NVARCHAR(50))
				,@InputTypeID = [2]
				,@ValidationTypeID = [3]
				,@AttributeValue = [4]
			FROM (
				SELECT Attribute = RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
					,rn = ROW_NUMBER() OVER (
						ORDER BY (
								SELECT 1
								)
						)
				FROM (
					SELECT field = CAST('<s>' + REPLACE(Attribute, '@', '</s><s>') + '</s>' AS XML)
					FROM @tblAttributes
					WHERE RowNum = @Counter
					) d
				CROSS APPLY field.nodes('/s') t(p)
				) r
			PIVOT(MAX(Attribute) FOR rn IN (
						[1]
						,[2]
						,[3]
						,[4]
						)) p

			SELECT @SQL = CASE 
					WHEN @InputTypeID = 1
						THEN CASE 
								WHEN @ValidationTypeID = 3
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Decimal
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								WHEN @ValidationTypeID = 5
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Int
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								ELSE 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Nvarchar
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								END
					WHEN @InputTypeID IN (
							5
							,6
							,9
							,10
							,11
							,12
							)
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Options aios LEFT JOIN Aspx_AttributeValues avs ON aios.AttributeID = avs.AttributeID AND avs.AttributeValueID IN (SELECT rtrim(ltrim(items)) FROM split(aios.AttributeValue, '',''))
                  LEFT JOIN [dbo].[Aspx_AttributeValuesAlias] AVA ON avs.AttributeValueID = AVA.AttributeValueID
                  WHERE cast(COALESCE(AVA.[Value], avs.[Value]) AS NVARCHAR) IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND aios.AttributeID =' + @AttributeID + ' AND aios.IsDeleted=0'
					WHEN @InputTypeID = 7
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Decimal 
                  WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
					END

			INSERT INTO @Tbl
			VALUES (@SQL)

			SET @Counter = @Counter + 1
		END

		DECLARE @Counter1 INT
			,@RowCount1 INT
			,@Sql1 NVARCHAR(max)
			,@tId NVARCHAR(50)

		SELECT @RowCount1 = COUNT(RowNum)
			,@Counter1 = 1
		FROM @Tbl

		SELECT @Sql1 = ''

		WHILE @Counter1 <= @RowCount1
			OR @Counter1 = 1
		BEGIN
			IF (@RowCount1 = 1)
			BEGIN
				SELECT @Sql1 = SQL
				FROM @Tbl
				WHERE RowNum = @Counter1
			END
			ELSE
			BEGIN
				IF (@Counter1 = 1)
				BEGIN
					SELECT @Sql1 = ' SELECT t1.ItemID FROM ( ' + @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' inner join ('
					FROM @Tbl
					WHERE RowNum = @Counter1
				END
				ELSE
				BEGIN
					IF (@Counter1 = @RowCount1)
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID'
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
					ELSE
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID' + ' inner join ('
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
				END

				SELECT @tId = 't' + CAST(@Counter1 AS VARCHAR);
			END

			SET @Counter1 = @Counter1 + 1
		END

		INSERT INTO @tblFinal
		EXEC (@Sql1)
	END;

	IF (@CategoryID IS NULL)
	BEGIN
		IF (@BrandID = 0)
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN dbo.Aspx_Currency c ON i.CurrencyCode = c.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.IsFeatured DESC
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
		ELSE
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.IsFeatured DESC
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
	END
	ELSE
	BEGIN
		IF (@IsGiftCard = 0)
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.IsFeatured DESC
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.IsFeatured DESC
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.IsFeatured DESC
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.IsFeatured DESC
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
		ELSE
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.IsFeatured DESC
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.IsFeatured DESC
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.IsFeatured DESC
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.IsFeatured DESC
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
	END
END

GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByIsSpecial]    Script Date: 02/19/2014 12:28:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- [dbo].[usp_Aspx_AdvanceSearchSortByIsSpecial] 1,100,NULL,'a',8,NULL,NULL,'',0,1,1,'superuser','en-US'
-- =============================================
CREATE PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByIsSpecial]
	-- Add the parameters for the stored procedure here
	(
	@offset INT
	,@limit INT
	,@CategoryID INT = NULL
	,@IsGiftCard BIT
	,@SearchText NVARCHAR(1000)
	,@BrandID INT
	,@PriceFrom DECIMAL(16, 4) = NULL
	,@PriceTo DECIMAL(16, 4) = NULL
	,@Attributes NVARCHAR(4000)
	,@RowTotal INT
	,@StoreID INT
	,@PortalID INT
	,@UserName NVARCHAR(256)
	,@CultureName NVARCHAR(256)
	)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @tblFinal TABLE (ItemID INT)

	IF (@Attributes != '')
	BEGIN
		DECLARE @Tbl TABLE (
			RowNum INT identity(1, 1)
			,SQL NVARCHAR(4000)
			);
		DECLARE @SQL NVARCHAR(MAX)
		DECLARE @tblAttributes TABLE (
			RowNum INT IDENTITY(1, 1)
			,Attribute NVARCHAR(1000)
			)

		INSERT INTO @tblAttributes (Attribute)
		SELECT RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
		FROM (
			SELECT field = CAST('<s>' + REPLACE(@Attributes, ',', '</s><s>') + '</s>' AS XML)
			) d
		CROSS APPLY field.nodes('/s') t(p)

		DECLARE @Counter INT
			,@RowCount INT

		SELECT @RowCount = COUNT(RowNum)
			,@Counter = 1
		FROM @tblAttributes

		WHILE @Counter <= @RowCount
			OR @Counter = 1
		BEGIN
			DECLARE @AttributeID NVARCHAR(50)
				,@InputTypeID INT
				,@ValidationTypeID INT
				,@AttributeValue NVARCHAR(4000)

			SELECT @AttributeID = cast([1] AS NVARCHAR(50))
				,@InputTypeID = [2]
				,@ValidationTypeID = [3]
				,@AttributeValue = [4]
			FROM (
				SELECT Attribute = RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
					,rn = ROW_NUMBER() OVER (
						ORDER BY (
								SELECT 1
								)
						)
				FROM (
					SELECT field = CAST('<s>' + REPLACE(Attribute, '@', '</s><s>') + '</s>' AS XML)
					FROM @tblAttributes
					WHERE RowNum = @Counter
					) d
				CROSS APPLY field.nodes('/s') t(p)
				) r
			PIVOT(MAX(Attribute) FOR rn IN (
						[1]
						,[2]
						,[3]
						,[4]
						)) p

			SELECT @SQL = CASE 
					WHEN @InputTypeID = 1
						THEN CASE 
								WHEN @ValidationTypeID = 3
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Decimal
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								WHEN @ValidationTypeID = 5
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Int
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								ELSE 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Nvarchar
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								END
					WHEN @InputTypeID IN (
							5
							,6
							,9
							,10
							,11
							,12
							)
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Options aios LEFT JOIN Aspx_AttributeValues avs ON aios.AttributeID = avs.AttributeID AND avs.AttributeValueID IN (SELECT rtrim(ltrim(items)) FROM split(aios.AttributeValue, '',''))
                  LEFT JOIN [dbo].[Aspx_AttributeValuesAlias] AVA ON avs.AttributeValueID = AVA.AttributeValueID
                  WHERE cast(COALESCE(AVA.[Value], avs.[Value]) AS NVARCHAR) IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND aios.AttributeID =' + @AttributeID + ' AND aios.IsDeleted=0'
					WHEN @InputTypeID = 7
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Decimal 
                  WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
					END

			INSERT INTO @Tbl
			VALUES (@SQL)

			SET @Counter = @Counter + 1
		END

		DECLARE @Counter1 INT
			,@RowCount1 INT
			,@Sql1 NVARCHAR(max)
			,@tId NVARCHAR(50)

		SELECT @RowCount1 = COUNT(RowNum)
			,@Counter1 = 1
		FROM @Tbl

		SELECT @Sql1 = ''

		WHILE @Counter1 <= @RowCount1
			OR @Counter1 = 1
		BEGIN
			IF (@RowCount1 = 1)
			BEGIN
				SELECT @Sql1 = SQL
				FROM @Tbl
				WHERE RowNum = @Counter1
			END
			ELSE
			BEGIN
				IF (@Counter1 = 1)
				BEGIN
					SELECT @Sql1 = ' SELECT t1.ItemID FROM ( ' + @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' inner join ('
					FROM @Tbl
					WHERE RowNum = @Counter1
				END
				ELSE
				BEGIN
					IF (@Counter1 = @RowCount1)
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID'
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
					ELSE
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID' + ' inner join ('
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
				END

				SELECT @tId = 't' + CAST(@Counter1 AS VARCHAR);
			END

			SET @Counter1 = @Counter1 + 1
		END

		INSERT INTO @tblFinal
		EXEC (@Sql1)
	END;

	IF (@CategoryID IS NULL)
	BEGIN
		IF (@BrandID = 0)
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN dbo.Aspx_Currency c ON i.CurrencyCode = c.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.IsSpecial DESC
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
		ELSE
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.IsSpecial DESC
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
	END
	ELSE
	BEGIN
		IF (@IsGiftCard = 0)
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.IsSpecial DESC
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.IsSpecial DESC
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.IsSpecial DESC
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.IsSpecial DESC
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
		ELSE
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.IsSpecial DESC
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.IsSpecial DESC
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.IsSpecial DESC
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.IsSpecial DESC
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
	END
END

GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByItemID]    Script Date: 02/19/2014 12:28:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- [dbo].[usp_Aspx_AdvanceSearchSortByItemID] 1,100,NULL,'a',8,NULL,NULL,'',0,1,1,'superuser','en-US'
-- =============================================
CREATE PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByItemID]
	-- Add the parameters for the stored procedure here
	(
	@offset INT
	,@limit INT
	,@CategoryID INT = NULL
	,@IsGiftCard BIT
	,@SearchText NVARCHAR(1000)
	,@BrandID INT
	,@PriceFrom DECIMAL(16, 4) = NULL
	,@PriceTo DECIMAL(16, 4) = NULL
	,@Attributes NVARCHAR(4000)
	,@RowTotal INT
	,@StoreID INT
	,@PortalID INT
	,@UserName NVARCHAR(256)
	,@CultureName NVARCHAR(256)
	)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @tblFinal TABLE (ItemID INT)

	IF (@Attributes != '')
	BEGIN
		DECLARE @Tbl TABLE (
			RowNum INT identity(1, 1)
			,SQL NVARCHAR(4000)
			);
		DECLARE @SQL NVARCHAR(MAX)
		DECLARE @tblAttributes TABLE (
			RowNum INT IDENTITY(1, 1)
			,Attribute NVARCHAR(1000)
			)

		INSERT INTO @tblAttributes (Attribute)
		SELECT RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
		FROM (
			SELECT field = CAST('<s>' + REPLACE(@Attributes, ',', '</s><s>') + '</s>' AS XML)
			) d
		CROSS APPLY field.nodes('/s') t(p)

		DECLARE @Counter INT
			,@RowCount INT

		SELECT @RowCount = COUNT(RowNum)
			,@Counter = 1
		FROM @tblAttributes

		WHILE @Counter <= @RowCount
			OR @Counter = 1
		BEGIN
			DECLARE @AttributeID NVARCHAR(50)
				,@InputTypeID INT
				,@ValidationTypeID INT
				,@AttributeValue NVARCHAR(4000)

			SELECT @AttributeID = cast([1] AS NVARCHAR(50))
				,@InputTypeID = [2]
				,@ValidationTypeID = [3]
				,@AttributeValue = [4]
			FROM (
				SELECT Attribute = RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
					,rn = ROW_NUMBER() OVER (
						ORDER BY (
								SELECT 1
								)
						)
				FROM (
					SELECT field = CAST('<s>' + REPLACE(Attribute, '@', '</s><s>') + '</s>' AS XML)
					FROM @tblAttributes
					WHERE RowNum = @Counter
					) d
				CROSS APPLY field.nodes('/s') t(p)
				) r
			PIVOT(MAX(Attribute) FOR rn IN (
						[1]
						,[2]
						,[3]
						,[4]
						)) p

			SELECT @SQL = CASE 
					WHEN @InputTypeID = 1
						THEN CASE 
								WHEN @ValidationTypeID = 3
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Decimal
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								WHEN @ValidationTypeID = 5
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Int
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								ELSE 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Nvarchar
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								END
					WHEN @InputTypeID IN (
							5
							,6
							,9
							,10
							,11
							,12
							)
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Options aios LEFT JOIN Aspx_AttributeValues avs ON aios.AttributeID = avs.AttributeID AND avs.AttributeValueID IN (SELECT rtrim(ltrim(items)) FROM split(aios.AttributeValue, '',''))
                  LEFT JOIN [dbo].[Aspx_AttributeValuesAlias] AVA ON avs.AttributeValueID = AVA.AttributeValueID
                  WHERE cast(COALESCE(AVA.[Value], avs.[Value]) AS NVARCHAR) IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND aios.AttributeID =' + @AttributeID + ' AND aios.IsDeleted=0'
					WHEN @InputTypeID = 7
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Decimal 
                  WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
					END

			INSERT INTO @Tbl
			VALUES (@SQL)

			SET @Counter = @Counter + 1
		END

		DECLARE @Counter1 INT
			,@RowCount1 INT
			,@Sql1 NVARCHAR(max)
			,@tId NVARCHAR(50)

		SELECT @RowCount1 = COUNT(RowNum)
			,@Counter1 = 1
		FROM @Tbl

		SELECT @Sql1 = ''

		WHILE @Counter1 <= @RowCount1
			OR @Counter1 = 1
		BEGIN
			IF (@RowCount1 = 1)
			BEGIN
				SELECT @Sql1 = SQL
				FROM @Tbl
				WHERE RowNum = @Counter1
			END
			ELSE
			BEGIN
				IF (@Counter1 = 1)
				BEGIN
					SELECT @Sql1 = ' SELECT t1.ItemID FROM ( ' + @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' inner join ('
					FROM @Tbl
					WHERE RowNum = @Counter1
				END
				ELSE
				BEGIN
					IF (@Counter1 = @RowCount1)
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID'
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
					ELSE
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID' + ' inner join ('
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
				END

				SELECT @tId = 't' + CAST(@Counter1 AS VARCHAR);
			END

			SET @Counter1 = @Counter1 + 1
		END

		INSERT INTO @tblFinal
		EXEC (@Sql1)
	END;

	IF (@CategoryID IS NULL)
	BEGIN
		IF (@BrandID = 0)
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN dbo.Aspx_Currency c ON i.CurrencyCode = c.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.ItemID
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
		ELSE
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.ItemID
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
	END
	ELSE
	BEGIN
		IF (@IsGiftCard = 0)
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.ItemID
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.ItemID
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.ItemID
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.ItemID
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
		ELSE
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.ItemID
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.ItemID
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.ItemID
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.ItemID
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
	END
END

GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByItemIDDesc]    Script Date: 02/19/2014 12:28:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- [dbo].[usp_Aspx_AdvanceSearchSortByItemIDDesc] 1,100,NULL,'a',8,NULL,NULL,'',0,1,1,'superuser','en-US'
-- =============================================
CREATE PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByItemIDDesc]
	-- Add the parameters for the stored procedure here
	(
	@offset INT
	,@limit INT
	,@CategoryID INT = NULL
	,@IsGiftCard BIT
	,@SearchText NVARCHAR(1000)
	,@BrandID INT
	,@PriceFrom DECIMAL(16, 4) = NULL
	,@PriceTo DECIMAL(16, 4) = NULL
	,@Attributes NVARCHAR(4000)
	,@RowTotal INT
	,@StoreID INT
	,@PortalID INT
	,@UserName NVARCHAR(256)
	,@CultureName NVARCHAR(256)
	)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @tblFinal TABLE (ItemID INT)

	IF (@Attributes != '')
	BEGIN
		DECLARE @Tbl TABLE (
			RowNum INT identity(1, 1)
			,SQL NVARCHAR(4000)
			);
		DECLARE @SQL NVARCHAR(MAX)
		DECLARE @tblAttributes TABLE (
			RowNum INT IDENTITY(1, 1)
			,Attribute NVARCHAR(1000)
			)

		INSERT INTO @tblAttributes (Attribute)
		SELECT RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
		FROM (
			SELECT field = CAST('<s>' + REPLACE(@Attributes, ',', '</s><s>') + '</s>' AS XML)
			) d
		CROSS APPLY field.nodes('/s') t(p)

		DECLARE @Counter INT
			,@RowCount INT

		SELECT @RowCount = COUNT(RowNum)
			,@Counter = 1
		FROM @tblAttributes

		WHILE @Counter <= @RowCount
			OR @Counter = 1
		BEGIN
			DECLARE @AttributeID NVARCHAR(50)
				,@InputTypeID INT
				,@ValidationTypeID INT
				,@AttributeValue NVARCHAR(4000)

			SELECT @AttributeID = cast([1] AS NVARCHAR(50))
				,@InputTypeID = [2]
				,@ValidationTypeID = [3]
				,@AttributeValue = [4]
			FROM (
				SELECT Attribute = RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
					,rn = ROW_NUMBER() OVER (
						ORDER BY (
								SELECT 1
								)
						)
				FROM (
					SELECT field = CAST('<s>' + REPLACE(Attribute, '@', '</s><s>') + '</s>' AS XML)
					FROM @tblAttributes
					WHERE RowNum = @Counter
					) d
				CROSS APPLY field.nodes('/s') t(p)
				) r
			PIVOT(MAX(Attribute) FOR rn IN (
						[1]
						,[2]
						,[3]
						,[4]
						)) p

			SELECT @SQL = CASE 
					WHEN @InputTypeID = 1
						THEN CASE 
								WHEN @ValidationTypeID = 3
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Decimal
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								WHEN @ValidationTypeID = 5
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Int
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								ELSE 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Nvarchar
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								END
					WHEN @InputTypeID IN (
							5
							,6
							,9
							,10
							,11
							,12
							)
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Options aios LEFT JOIN Aspx_AttributeValues avs ON aios.AttributeID = avs.AttributeID AND avs.AttributeValueID IN (SELECT rtrim(ltrim(items)) FROM split(aios.AttributeValue, '',''))
                  LEFT JOIN [dbo].[Aspx_AttributeValuesAlias] AVA ON avs.AttributeValueID = AVA.AttributeValueID
                  WHERE cast(COALESCE(AVA.[Value], avs.[Value]) AS NVARCHAR) IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND aios.AttributeID =' + @AttributeID + ' AND aios.IsDeleted=0'
					WHEN @InputTypeID = 7
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Decimal 
                  WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
					END

			INSERT INTO @Tbl
			VALUES (@SQL)

			SET @Counter = @Counter + 1
		END

		DECLARE @Counter1 INT
			,@RowCount1 INT
			,@Sql1 NVARCHAR(max)
			,@tId NVARCHAR(50)

		SELECT @RowCount1 = COUNT(RowNum)
			,@Counter1 = 1
		FROM @Tbl

		SELECT @Sql1 = ''

		WHILE @Counter1 <= @RowCount1
			OR @Counter1 = 1
		BEGIN
			IF (@RowCount1 = 1)
			BEGIN
				SELECT @Sql1 = SQL
				FROM @Tbl
				WHERE RowNum = @Counter1
			END
			ELSE
			BEGIN
				IF (@Counter1 = 1)
				BEGIN
					SELECT @Sql1 = ' SELECT t1.ItemID FROM ( ' + @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' inner join ('
					FROM @Tbl
					WHERE RowNum = @Counter1
				END
				ELSE
				BEGIN
					IF (@Counter1 = @RowCount1)
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID'
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
					ELSE
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID' + ' inner join ('
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
				END

				SELECT @tId = 't' + CAST(@Counter1 AS VARCHAR);
			END

			SET @Counter1 = @Counter1 + 1
		END

		INSERT INTO @tblFinal
		EXEC (@Sql1)
	END;

	IF (@CategoryID IS NULL)
	BEGIN
		IF (@BrandID = 0)
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN dbo.Aspx_Currency c ON i.CurrencyCode = c.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.ItemID DESC
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
		ELSE
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.ItemID DESC
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
	END
	ELSE
	BEGIN
		IF (@IsGiftCard = 0)
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.ItemID DESC
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.ItemID DESC
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.ItemID DESC
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.ItemID DESC
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
		ELSE
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.ItemID DESC
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.ItemID DESC
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.ItemID DESC
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.ItemID DESC
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
	END
END

GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByName]    Script Date: 02/19/2014 12:28:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- [dbo].[usp_Aspx_AdvanceSearchSortByName] 1,100,NULL,'a',8,NULL,NULL,'',0,1,1,'superuser','en-US'
-- =============================================
CREATE PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByName]
	-- Add the parameters for the stored procedure here
	(
	@offset INT
	,@limit INT
	,@CategoryID INT = NULL
	,@IsGiftCard BIT
	,@SearchText NVARCHAR(1000)
	,@BrandID INT
	,@PriceFrom DECIMAL(16, 4) = NULL
	,@PriceTo DECIMAL(16, 4) = NULL
	,@Attributes NVARCHAR(4000)
	,@RowTotal INT
	,@StoreID INT
	,@PortalID INT
	,@UserName NVARCHAR(256)
	,@CultureName NVARCHAR(256)
	)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @tblFinal TABLE (ItemID INT)

	IF (@Attributes != '')
	BEGIN
		DECLARE @Tbl TABLE (
			RowNum INT identity(1, 1)
			,SQL NVARCHAR(4000)
			);
		DECLARE @SQL NVARCHAR(MAX)
		DECLARE @tblAttributes TABLE (
			RowNum INT IDENTITY(1, 1)
			,Attribute NVARCHAR(1000)
			)

		INSERT INTO @tblAttributes (Attribute)
		SELECT RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
		FROM (
			SELECT field = CAST('<s>' + REPLACE(@Attributes, ',', '</s><s>') + '</s>' AS XML)
			) d
		CROSS APPLY field.nodes('/s') t(p)

		DECLARE @Counter INT
			,@RowCount INT

		SELECT @RowCount = COUNT(RowNum)
			,@Counter = 1
		FROM @tblAttributes

		WHILE @Counter <= @RowCount
			OR @Counter = 1
		BEGIN
			DECLARE @AttributeID NVARCHAR(50)
				,@InputTypeID INT
				,@ValidationTypeID INT
				,@AttributeValue NVARCHAR(4000)

			SELECT @AttributeID = cast([1] AS NVARCHAR(50))
				,@InputTypeID = [2]
				,@ValidationTypeID = [3]
				,@AttributeValue = [4]
			FROM (
				SELECT Attribute = RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
					,rn = ROW_NUMBER() OVER (
						ORDER BY (
								SELECT 1
								)
						)
				FROM (
					SELECT field = CAST('<s>' + REPLACE(Attribute, '@', '</s><s>') + '</s>' AS XML)
					FROM @tblAttributes
					WHERE RowNum = @Counter
					) d
				CROSS APPLY field.nodes('/s') t(p)
				) r
			PIVOT(MAX(Attribute) FOR rn IN (
						[1]
						,[2]
						,[3]
						,[4]
						)) p

			SELECT @SQL = CASE 
					WHEN @InputTypeID = 1
						THEN CASE 
								WHEN @ValidationTypeID = 3
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Decimal
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								WHEN @ValidationTypeID = 5
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Int
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								ELSE 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Nvarchar
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								END
					WHEN @InputTypeID IN (
							5
							,6
							,9
							,10
							,11
							,12
							)
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Options aios LEFT JOIN Aspx_AttributeValues avs ON aios.AttributeID = avs.AttributeID AND avs.AttributeValueID IN (SELECT rtrim(ltrim(items)) FROM split(aios.AttributeValue, '',''))
                  LEFT JOIN [dbo].[Aspx_AttributeValuesAlias] AVA ON avs.AttributeValueID = AVA.AttributeValueID
                  WHERE cast(COALESCE(AVA.[Value], avs.[Value]) AS NVARCHAR) IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND aios.AttributeID =' + @AttributeID + ' AND aios.IsDeleted=0'
					WHEN @InputTypeID = 7
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Decimal 
                  WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
					END

			INSERT INTO @Tbl
			VALUES (@SQL)

			SET @Counter = @Counter + 1
		END

		DECLARE @Counter1 INT
			,@RowCount1 INT
			,@Sql1 NVARCHAR(max)
			,@tId NVARCHAR(50)

		SELECT @RowCount1 = COUNT(RowNum)
			,@Counter1 = 1
		FROM @Tbl

		SELECT @Sql1 = ''

		WHILE @Counter1 <= @RowCount1
			OR @Counter1 = 1
		BEGIN
			IF (@RowCount1 = 1)
			BEGIN
				SELECT @Sql1 = SQL
				FROM @Tbl
				WHERE RowNum = @Counter1
			END
			ELSE
			BEGIN
				IF (@Counter1 = 1)
				BEGIN
					SELECT @Sql1 = ' SELECT t1.ItemID FROM ( ' + @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' inner join ('
					FROM @Tbl
					WHERE RowNum = @Counter1
				END
				ELSE
				BEGIN
					IF (@Counter1 = @RowCount1)
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID'
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
					ELSE
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID' + ' inner join ('
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
				END

				SELECT @tId = 't' + CAST(@Counter1 AS VARCHAR);
			END

			SET @Counter1 = @Counter1 + 1
		END

		INSERT INTO @tblFinal
		EXEC (@Sql1)
	END;

	IF (@CategoryID IS NULL)
	BEGIN
		IF (@BrandID = 0)
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN dbo.Aspx_Currency c ON i.CurrencyCode = c.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY iid.NAME
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
		ELSE
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY iid.NAME
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
	END
	ELSE
	BEGIN
		IF (@IsGiftCard = 0)
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY iid.NAME
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY iid.NAME
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY iid.NAME
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY iid.NAME
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
		ELSE
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY iid.NAME
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY iid.NAME
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY iid.NAME
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY iid.NAME
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
	END
END

GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByPrice]    Script Date: 02/19/2014 12:28:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- [dbo].[usp_Aspx_AdvanceSearchSortByPrice] 1,100,NULL,'a',8,NULL,NULL,'',0,1,1,'superuser','en-US'
-- =============================================
CREATE PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByPrice]
	-- Add the parameters for the stored procedure here
	(
	@offset INT
	,@limit INT
	,@CategoryID INT = NULL
	,@IsGiftCard BIT
	,@SearchText NVARCHAR(1000)
	,@BrandID INT
	,@PriceFrom DECIMAL(16, 4) = NULL
	,@PriceTo DECIMAL(16, 4) = NULL
	,@Attributes NVARCHAR(4000)
	,@RowTotal INT
	,@StoreID INT
	,@PortalID INT
	,@UserName NVARCHAR(256)
	,@CultureName NVARCHAR(256)
	)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @tblFinal TABLE (ItemID INT)

	IF (@Attributes != '')
	BEGIN
		DECLARE @Tbl TABLE (
			RowNum INT identity(1, 1)
			,SQL NVARCHAR(4000)
			);
		DECLARE @SQL NVARCHAR(MAX)
		DECLARE @tblAttributes TABLE (
			RowNum INT IDENTITY(1, 1)
			,Attribute NVARCHAR(1000)
			)

		INSERT INTO @tblAttributes (Attribute)
		SELECT RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
		FROM (
			SELECT field = CAST('<s>' + REPLACE(@Attributes, ',', '</s><s>') + '</s>' AS XML)
			) d
		CROSS APPLY field.nodes('/s') t(p)

		DECLARE @Counter INT
			,@RowCount INT

		SELECT @RowCount = COUNT(RowNum)
			,@Counter = 1
		FROM @tblAttributes

		WHILE @Counter <= @RowCount
			OR @Counter = 1
		BEGIN
			DECLARE @AttributeID NVARCHAR(50)
				,@InputTypeID INT
				,@ValidationTypeID INT
				,@AttributeValue NVARCHAR(4000)

			SELECT @AttributeID = cast([1] AS NVARCHAR(50))
				,@InputTypeID = [2]
				,@ValidationTypeID = [3]
				,@AttributeValue = [4]
			FROM (
				SELECT Attribute = RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
					,rn = ROW_NUMBER() OVER (
						ORDER BY (
								SELECT 1
								)
						)
				FROM (
					SELECT field = CAST('<s>' + REPLACE(Attribute, '@', '</s><s>') + '</s>' AS XML)
					FROM @tblAttributes
					WHERE RowNum = @Counter
					) d
				CROSS APPLY field.nodes('/s') t(p)
				) r
			PIVOT(MAX(Attribute) FOR rn IN (
						[1]
						,[2]
						,[3]
						,[4]
						)) p

			SELECT @SQL = CASE 
					WHEN @InputTypeID = 1
						THEN CASE 
								WHEN @ValidationTypeID = 3
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Decimal
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								WHEN @ValidationTypeID = 5
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Int
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								ELSE 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Nvarchar
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								END
					WHEN @InputTypeID IN (
							5
							,6
							,9
							,10
							,11
							,12
							)
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Options aios LEFT JOIN Aspx_AttributeValues avs ON aios.AttributeID = avs.AttributeID AND avs.AttributeValueID IN (SELECT rtrim(ltrim(items)) FROM split(aios.AttributeValue, '',''))
                  LEFT JOIN [dbo].[Aspx_AttributeValuesAlias] AVA ON avs.AttributeValueID = AVA.AttributeValueID
                  WHERE cast(COALESCE(AVA.[Value], avs.[Value]) AS NVARCHAR) IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND aios.AttributeID =' + @AttributeID + ' AND aios.IsDeleted=0'
					WHEN @InputTypeID = 7
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Decimal 
                  WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
					END

			INSERT INTO @Tbl
			VALUES (@SQL)

			SET @Counter = @Counter + 1
		END

		DECLARE @Counter1 INT
			,@RowCount1 INT
			,@Sql1 NVARCHAR(max)
			,@tId NVARCHAR(50)

		SELECT @RowCount1 = COUNT(RowNum)
			,@Counter1 = 1
		FROM @Tbl

		SELECT @Sql1 = ''

		WHILE @Counter1 <= @RowCount1
			OR @Counter1 = 1
		BEGIN
			IF (@RowCount1 = 1)
			BEGIN
				SELECT @Sql1 = SQL
				FROM @Tbl
				WHERE RowNum = @Counter1
			END
			ELSE
			BEGIN
				IF (@Counter1 = 1)
				BEGIN
					SELECT @Sql1 = ' SELECT t1.ItemID FROM ( ' + @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' inner join ('
					FROM @Tbl
					WHERE RowNum = @Counter1
				END
				ELSE
				BEGIN
					IF (@Counter1 = @RowCount1)
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID'
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
					ELSE
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID' + ' inner join ('
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
				END

				SELECT @tId = 't' + CAST(@Counter1 AS VARCHAR);
			END

			SET @Counter1 = @Counter1 + 1
		END

		INSERT INTO @tblFinal
		EXEC (@Sql1)
	END;

	IF (@CategoryID IS NULL)
	BEGIN
		IF (@BrandID = 0)
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN dbo.Aspx_Currency c ON i.CurrencyCode = c.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.Price
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
		ELSE
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.Price
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
	END
	ELSE
	BEGIN
		IF (@IsGiftCard = 0)
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.Price
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.Price
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.Price
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.Price
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
		ELSE
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.Price
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.Price
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.Price
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.Price
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
	END
END

GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByPriceDesc]    Script Date: 02/19/2014 12:28:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- [dbo].[usp_Aspx_AdvanceSearchSortByPriceDesc] 1,100,NULL,'a',8,NULL,NULL,'',0,1,1,'superuser','en-US'
-- =============================================
CREATE PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByPriceDesc]
	-- Add the parameters for the stored procedure here
	(
	@offset INT
	,@limit INT
	,@CategoryID INT = NULL
	,@IsGiftCard BIT
	,@SearchText NVARCHAR(1000)
	,@BrandID INT
	,@PriceFrom DECIMAL(16, 4) = NULL
	,@PriceTo DECIMAL(16, 4) = NULL
	,@Attributes NVARCHAR(4000)
	,@RowTotal INT
	,@StoreID INT
	,@PortalID INT
	,@UserName NVARCHAR(256)
	,@CultureName NVARCHAR(256)
	)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @tblFinal TABLE (ItemID INT)

	IF (@Attributes != '')
	BEGIN
		DECLARE @Tbl TABLE (
			RowNum INT identity(1, 1)
			,SQL NVARCHAR(4000)
			);
		DECLARE @SQL NVARCHAR(MAX)
		DECLARE @tblAttributes TABLE (
			RowNum INT IDENTITY(1, 1)
			,Attribute NVARCHAR(1000)
			)

		INSERT INTO @tblAttributes (Attribute)
		SELECT RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
		FROM (
			SELECT field = CAST('<s>' + REPLACE(@Attributes, ',', '</s><s>') + '</s>' AS XML)
			) d
		CROSS APPLY field.nodes('/s') t(p)

		DECLARE @Counter INT
			,@RowCount INT

		SELECT @RowCount = COUNT(RowNum)
			,@Counter = 1
		FROM @tblAttributes

		WHILE @Counter <= @RowCount
			OR @Counter = 1
		BEGIN
			DECLARE @AttributeID NVARCHAR(50)
				,@InputTypeID INT
				,@ValidationTypeID INT
				,@AttributeValue NVARCHAR(4000)

			SELECT @AttributeID = cast([1] AS NVARCHAR(50))
				,@InputTypeID = [2]
				,@ValidationTypeID = [3]
				,@AttributeValue = [4]
			FROM (
				SELECT Attribute = RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
					,rn = ROW_NUMBER() OVER (
						ORDER BY (
								SELECT 1
								)
						)
				FROM (
					SELECT field = CAST('<s>' + REPLACE(Attribute, '@', '</s><s>') + '</s>' AS XML)
					FROM @tblAttributes
					WHERE RowNum = @Counter
					) d
				CROSS APPLY field.nodes('/s') t(p)
				) r
			PIVOT(MAX(Attribute) FOR rn IN (
						[1]
						,[2]
						,[3]
						,[4]
						)) p

			SELECT @SQL = CASE 
					WHEN @InputTypeID = 1
						THEN CASE 
								WHEN @ValidationTypeID = 3
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Decimal
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								WHEN @ValidationTypeID = 5
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Int
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								ELSE 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Nvarchar
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								END
					WHEN @InputTypeID IN (
							5
							,6
							,9
							,10
							,11
							,12
							)
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Options aios LEFT JOIN Aspx_AttributeValues avs ON aios.AttributeID = avs.AttributeID AND avs.AttributeValueID IN (SELECT rtrim(ltrim(items)) FROM split(aios.AttributeValue, '',''))
                  LEFT JOIN [dbo].[Aspx_AttributeValuesAlias] AVA ON avs.AttributeValueID = AVA.AttributeValueID
                  WHERE cast(COALESCE(AVA.[Value], avs.[Value]) AS NVARCHAR) IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND aios.AttributeID =' + @AttributeID + ' AND aios.IsDeleted=0'
					WHEN @InputTypeID = 7
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Decimal 
                  WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
					END

			INSERT INTO @Tbl
			VALUES (@SQL)

			SET @Counter = @Counter + 1
		END

		DECLARE @Counter1 INT
			,@RowCount1 INT
			,@Sql1 NVARCHAR(max)
			,@tId NVARCHAR(50)

		SELECT @RowCount1 = COUNT(RowNum)
			,@Counter1 = 1
		FROM @Tbl

		SELECT @Sql1 = ''

		WHILE @Counter1 <= @RowCount1
			OR @Counter1 = 1
		BEGIN
			IF (@RowCount1 = 1)
			BEGIN
				SELECT @Sql1 = SQL
				FROM @Tbl
				WHERE RowNum = @Counter1
			END
			ELSE
			BEGIN
				IF (@Counter1 = 1)
				BEGIN
					SELECT @Sql1 = ' SELECT t1.ItemID FROM ( ' + @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' inner join ('
					FROM @Tbl
					WHERE RowNum = @Counter1
				END
				ELSE
				BEGIN
					IF (@Counter1 = @RowCount1)
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID'
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
					ELSE
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID' + ' inner join ('
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
				END

				SELECT @tId = 't' + CAST(@Counter1 AS VARCHAR);
			END

			SET @Counter1 = @Counter1 + 1
		END

		INSERT INTO @tblFinal
		EXEC (@Sql1)
	END;

	IF (@CategoryID IS NULL)
	BEGIN
		IF (@BrandID = 0)
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN dbo.Aspx_Currency c ON i.CurrencyCode = c.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.Price DESC
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
		ELSE
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.Price DESC
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
	END
	ELSE
	BEGIN
		IF (@IsGiftCard = 0)
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.Price DESC
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.Price DESC
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.Price DESC
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.Price DESC
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
		ELSE
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.Price DESC
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.Price DESC
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.Price DESC
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.Price DESC
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
	END
END

GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByRatedValue]    Script Date: 02/19/2014 12:28:32 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- [dbo].[usp_Aspx_AdvanceSearchSortByRatedValue] 1,100,NULL,'a',8,NULL,NULL,'',0,1,1,'superuser','en-US'
-- =============================================
CREATE PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByRatedValue]
	-- Add the parameters for the stored procedure here
	(
	@offset INT
	,@limit INT
	,@CategoryID INT = NULL
	,@IsGiftCard BIT
	,@SearchText NVARCHAR(1000)
	,@BrandID INT
	,@PriceFrom DECIMAL(16, 4) = NULL
	,@PriceTo DECIMAL(16, 4) = NULL
	,@Attributes NVARCHAR(4000)
	,@RowTotal INT
	,@StoreID INT
	,@PortalID INT
	,@UserName NVARCHAR(256)
	,@CultureName NVARCHAR(256)
	)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @tblFinal TABLE (ItemID INT)

	IF (@Attributes != '')
	BEGIN
		DECLARE @Tbl TABLE (
			RowNum INT identity(1, 1)
			,SQL NVARCHAR(4000)
			);
		DECLARE @SQL NVARCHAR(MAX)
		DECLARE @tblAttributes TABLE (
			RowNum INT IDENTITY(1, 1)
			,Attribute NVARCHAR(1000)
			)

		INSERT INTO @tblAttributes (Attribute)
		SELECT RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
		FROM (
			SELECT field = CAST('<s>' + REPLACE(@Attributes, ',', '</s><s>') + '</s>' AS XML)
			) d
		CROSS APPLY field.nodes('/s') t(p)

		DECLARE @Counter INT
			,@RowCount INT

		SELECT @RowCount = COUNT(RowNum)
			,@Counter = 1
		FROM @tblAttributes

		WHILE @Counter <= @RowCount
			OR @Counter = 1
		BEGIN
			DECLARE @AttributeID NVARCHAR(50)
				,@InputTypeID INT
				,@ValidationTypeID INT
				,@AttributeValue NVARCHAR(4000)

			SELECT @AttributeID = cast([1] AS NVARCHAR(50))
				,@InputTypeID = [2]
				,@ValidationTypeID = [3]
				,@AttributeValue = [4]
			FROM (
				SELECT Attribute = RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
					,rn = ROW_NUMBER() OVER (
						ORDER BY (
								SELECT 1
								)
						)
				FROM (
					SELECT field = CAST('<s>' + REPLACE(Attribute, '@', '</s><s>') + '</s>' AS XML)
					FROM @tblAttributes
					WHERE RowNum = @Counter
					) d
				CROSS APPLY field.nodes('/s') t(p)
				) r
			PIVOT(MAX(Attribute) FOR rn IN (
						[1]
						,[2]
						,[3]
						,[4]
						)) p

			SELECT @SQL = CASE 
					WHEN @InputTypeID = 1
						THEN CASE 
								WHEN @ValidationTypeID = 3
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Decimal
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								WHEN @ValidationTypeID = 5
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Int
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								ELSE 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Nvarchar
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								END
					WHEN @InputTypeID IN (
							5
							,6
							,9
							,10
							,11
							,12
							)
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Options aios LEFT JOIN Aspx_AttributeValues avs ON aios.AttributeID = avs.AttributeID AND avs.AttributeValueID IN (SELECT rtrim(ltrim(items)) FROM split(aios.AttributeValue, '',''))
                  LEFT JOIN [dbo].[Aspx_AttributeValuesAlias] AVA ON avs.AttributeValueID = AVA.AttributeValueID
                  WHERE cast(COALESCE(AVA.[Value], avs.[Value]) AS NVARCHAR) IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND aios.AttributeID =' + @AttributeID + ' AND aios.IsDeleted=0'
					WHEN @InputTypeID = 7
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Decimal 
                  WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
					END

			INSERT INTO @Tbl
			VALUES (@SQL)

			SET @Counter = @Counter + 1
		END

		DECLARE @Counter1 INT
			,@RowCount1 INT
			,@Sql1 NVARCHAR(max)
			,@tId NVARCHAR(50)

		SELECT @RowCount1 = COUNT(RowNum)
			,@Counter1 = 1
		FROM @Tbl

		SELECT @Sql1 = ''

		WHILE @Counter1 <= @RowCount1
			OR @Counter1 = 1
		BEGIN
			IF (@RowCount1 = 1)
			BEGIN
				SELECT @Sql1 = SQL
				FROM @Tbl
				WHERE RowNum = @Counter1
			END
			ELSE
			BEGIN
				IF (@Counter1 = 1)
				BEGIN
					SELECT @Sql1 = ' SELECT t1.ItemID FROM ( ' + @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' inner join ('
					FROM @Tbl
					WHERE RowNum = @Counter1
				END
				ELSE
				BEGIN
					IF (@Counter1 = @RowCount1)
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID'
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
					ELSE
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID' + ' inner join ('
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
				END

				SELECT @tId = 't' + CAST(@Counter1 AS VARCHAR);
			END

			SET @Counter1 = @Counter1 + 1
		END

		INSERT INTO @tblFinal
		EXEC (@Sql1)
	END;

	IF (@CategoryID IS NULL)
	BEGIN
		IF (@BrandID = 0)
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN dbo.Aspx_Currency c ON i.CurrencyCode = c.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.RatedValue DESC
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
		ELSE
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.RatedValue DESC
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
	END
	ELSE
	BEGIN
		IF (@IsGiftCard = 0)
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.RatedValue DESC
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.RatedValue DESC
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.RatedValue DESC
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.RatedValue DESC
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
		ELSE
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.RatedValue DESC
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.RatedValue DESC
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.RatedValue DESC
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.RatedValue DESC
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
	END
END

GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortBySoldItem]    Script Date: 02/19/2014 12:28:32 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- [dbo].[usp_Aspx_AdvanceSearchSortBySoldItem] 1,100,NULL,'a',8,NULL,NULL,'',0,1,1,'superuser','en-US'
-- =============================================
CREATE PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortBySoldItem]
	-- Add the parameters for the stored procedure here
	(
	@offset INT
	,@limit INT
	,@CategoryID INT = NULL
	,@IsGiftCard INT
	,@SearchText NVARCHAR(1000)
	,@BrandID INT
	,@PriceFrom DECIMAL(16, 4) = NULL
	,@PriceTo DECIMAL(16, 4) = NULL
	,@Attributes NVARCHAR(4000)
	,@RowTotal INT
	,@StoreID INT
	,@PortalID INT
	,@UserName NVARCHAR(256)
	,@CultureName NVARCHAR(256)
	)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @tblFinal TABLE (ItemID INT)

	IF (@Attributes != '')
	BEGIN
		DECLARE @Tbl TABLE (
			RowNum INT identity(1, 1)
			,SQL NVARCHAR(4000)
			);
		DECLARE @SQL NVARCHAR(MAX)
		DECLARE @tblAttributes TABLE (
			RowNum INT IDENTITY(1, 1)
			,Attribute NVARCHAR(1000)
			)

		INSERT INTO @tblAttributes (Attribute)
		SELECT RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
		FROM (
			SELECT field = CAST('<s>' + REPLACE(@Attributes, ',', '</s><s>') + '</s>' AS XML)
			) d
		CROSS APPLY field.nodes('/s') t(p)

		DECLARE @Counter INT
			,@RowCount INT

		SELECT @RowCount = COUNT(RowNum)
			,@Counter = 1
		FROM @tblAttributes

		WHILE @Counter <= @RowCount
			OR @Counter = 1
		BEGIN
			DECLARE @AttributeID NVARCHAR(50)
				,@InputTypeID INT
				,@ValidationTypeID INT
				,@AttributeValue NVARCHAR(4000)

			SELECT @AttributeID = cast([1] AS NVARCHAR(50))
				,@InputTypeID = [2]
				,@ValidationTypeID = [3]
				,@AttributeValue = [4]
			FROM (
				SELECT Attribute = RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
					,rn = ROW_NUMBER() OVER (
						ORDER BY (
								SELECT 1
								)
						)
				FROM (
					SELECT field = CAST('<s>' + REPLACE(Attribute, '@', '</s><s>') + '</s>' AS XML)
					FROM @tblAttributes
					WHERE RowNum = @Counter
					) d
				CROSS APPLY field.nodes('/s') t(p)
				) r
			PIVOT(MAX(Attribute) FOR rn IN (
						[1]
						,[2]
						,[3]
						,[4]
						)) p

			SELECT @SQL = CASE 
					WHEN @InputTypeID = 1
						THEN CASE 
								WHEN @ValidationTypeID = 3
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Decimal
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								WHEN @ValidationTypeID = 5
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Int
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								ELSE 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Nvarchar
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								END
					WHEN @InputTypeID IN (
							5
							,6
							,9
							,10
							,11
							,12
							)
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Options aios LEFT JOIN Aspx_AttributeValues avs ON aios.AttributeID = avs.AttributeID AND avs.AttributeValueID IN (SELECT rtrim(ltrim(items)) FROM split(aios.AttributeValue, '',''))
                  LEFT JOIN [dbo].[Aspx_AttributeValuesAlias] AVA ON avs.AttributeValueID = AVA.AttributeValueID
                  WHERE cast(COALESCE(AVA.[Value], avs.[Value]) AS NVARCHAR) IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND aios.AttributeID =' + @AttributeID + ' AND aios.IsDeleted=0'
					WHEN @InputTypeID = 7
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Decimal 
                  WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
					END

			INSERT INTO @Tbl
			VALUES (@SQL)

			SET @Counter = @Counter + 1
		END

		DECLARE @Counter1 INT
			,@RowCount1 INT
			,@Sql1 NVARCHAR(max)
			,@tId NVARCHAR(50)

		SELECT @RowCount1 = COUNT(RowNum)
			,@Counter1 = 1
		FROM @Tbl

		SELECT @Sql1 = ''

		WHILE @Counter1 <= @RowCount1
			OR @Counter1 = 1
		BEGIN
			IF (@RowCount1 = 1)
			BEGIN
				SELECT @Sql1 = SQL
				FROM @Tbl
				WHERE RowNum = @Counter1
			END
			ELSE
			BEGIN
				IF (@Counter1 = 1)
				BEGIN
					SELECT @Sql1 = ' SELECT t1.ItemID FROM ( ' + @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' inner join ('
					FROM @Tbl
					WHERE RowNum = @Counter1
				END
				ELSE
				BEGIN
					IF (@Counter1 = @RowCount1)
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID'
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
					ELSE
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID' + ' inner join ('
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
				END

				SELECT @tId = 't' + CAST(@Counter1 AS VARCHAR);
			END

			SET @Counter1 = @Counter1 + 1
		END

		INSERT INTO @tblFinal
		EXEC (@Sql1)
	END;

	IF (@CategoryID IS NULL)
	BEGIN
		IF (@BrandID = 0)
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN dbo.Aspx_Currency c ON i.CurrencyCode = c.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.SoldItem DESC
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
		ELSE
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.SoldItem DESC
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
	END
	ELSE
	BEGIN
		IF (@IsGiftCard = 0)
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.SoldItem DESC
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.SoldItem DESC
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.SoldItem DESC
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.SoldItem DESC
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
		ELSE
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.SoldItem DESC
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.SoldItem DESC
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.SoldItem DESC
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.SoldItem DESC
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
	END
END

GO

/****** Object:  StoredProcedure [dbo].[usp_Aspx_AdvanceSearchSortByViewCount]    Script Date: 02/19/2014 12:28:32 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- [dbo].[usp_Aspx_AdvanceSearchSortByViewCount] 1,100,NULL,'a',8,NULL,NULL,'',0,1,1,'superuser','en-US'
-- =============================================
CREATE PROCEDURE [dbo].[usp_Aspx_AdvanceSearchSortByViewCount]
	-- Add the parameters for the stored procedure here
	(
	@offset INT
	,@limit INT
	,@CategoryID INT = NULL
	,@IsGiftCard BIT
	,@SearchText NVARCHAR(1000)
	,@BrandID INT
	,@PriceFrom DECIMAL(16, 4) = NULL
	,@PriceTo DECIMAL(16, 4) = NULL
	,@Attributes NVARCHAR(4000)
	,@RowTotal INT
	,@StoreID INT
	,@PortalID INT
	,@UserName NVARCHAR(256)
	,@CultureName NVARCHAR(256)
	)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE @tblFinal TABLE (ItemID INT)

	IF (@Attributes != '')
	BEGIN
		DECLARE @Tbl TABLE (
			RowNum INT identity(1, 1)
			,SQL NVARCHAR(4000)
			);
		DECLARE @SQL NVARCHAR(MAX)
		DECLARE @tblAttributes TABLE (
			RowNum INT IDENTITY(1, 1)
			,Attribute NVARCHAR(1000)
			)

		INSERT INTO @tblAttributes (Attribute)
		SELECT RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
		FROM (
			SELECT field = CAST('<s>' + REPLACE(@Attributes, ',', '</s><s>') + '</s>' AS XML)
			) d
		CROSS APPLY field.nodes('/s') t(p)

		DECLARE @Counter INT
			,@RowCount INT

		SELECT @RowCount = COUNT(RowNum)
			,@Counter = 1
		FROM @tblAttributes

		WHILE @Counter <= @RowCount
			OR @Counter = 1
		BEGIN
			DECLARE @AttributeID NVARCHAR(50)
				,@InputTypeID INT
				,@ValidationTypeID INT
				,@AttributeValue NVARCHAR(4000)

			SELECT @AttributeID = cast([1] AS NVARCHAR(50))
				,@InputTypeID = [2]
				,@ValidationTypeID = [3]
				,@AttributeValue = [4]
			FROM (
				SELECT Attribute = RTRIM(LTRIM(p.value('.', 'NVARCHAR(4000)')))
					,rn = ROW_NUMBER() OVER (
						ORDER BY (
								SELECT 1
								)
						)
				FROM (
					SELECT field = CAST('<s>' + REPLACE(Attribute, '@', '</s><s>') + '</s>' AS XML)
					FROM @tblAttributes
					WHERE RowNum = @Counter
					) d
				CROSS APPLY field.nodes('/s') t(p)
				) r
			PIVOT(MAX(Attribute) FOR rn IN (
						[1]
						,[2]
						,[3]
						,[4]
						)) p

			SELECT @SQL = CASE 
					WHEN @InputTypeID = 1
						THEN CASE 
								WHEN @ValidationTypeID = 3
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Decimal
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								WHEN @ValidationTypeID = 5
									THEN 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Int
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								ELSE 'SELECT DISTINCT(ItemID) 
                          FROM dbo.Aspx_ItemAttributesValue_Nvarchar
                          WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                              AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
								END
					WHEN @InputTypeID IN (
							5
							,6
							,9
							,10
							,11
							,12
							)
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Options aios LEFT JOIN Aspx_AttributeValues avs ON aios.AttributeID = avs.AttributeID AND avs.AttributeValueID IN (SELECT rtrim(ltrim(items)) FROM split(aios.AttributeValue, '',''))
                  LEFT JOIN [dbo].[Aspx_AttributeValuesAlias] AVA ON avs.AttributeValueID = AVA.AttributeValueID
                  WHERE cast(COALESCE(AVA.[Value], avs.[Value]) AS NVARCHAR) IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND aios.AttributeID =' + @AttributeID + ' AND aios.IsDeleted=0'
					WHEN @InputTypeID = 7
						THEN 'SELECT DISTINCT(aios.ItemID) 
                  FROM dbo.Aspx_ItemAttributesValue_Decimal 
                  WHERE AttributeValue IN (SELECT RTRIM(LTRIM(items))FROM split(''' + @AttributeValue + ''', ''#'')) 
                      AND AttributeID =' + @AttributeID + ' AND IsDeleted=0'
					END

			INSERT INTO @Tbl
			VALUES (@SQL)

			SET @Counter = @Counter + 1
		END

		DECLARE @Counter1 INT
			,@RowCount1 INT
			,@Sql1 NVARCHAR(max)
			,@tId NVARCHAR(50)

		SELECT @RowCount1 = COUNT(RowNum)
			,@Counter1 = 1
		FROM @Tbl

		SELECT @Sql1 = ''

		WHILE @Counter1 <= @RowCount1
			OR @Counter1 = 1
		BEGIN
			IF (@RowCount1 = 1)
			BEGIN
				SELECT @Sql1 = SQL
				FROM @Tbl
				WHERE RowNum = @Counter1
			END
			ELSE
			BEGIN
				IF (@Counter1 = 1)
				BEGIN
					SELECT @Sql1 = ' SELECT t1.ItemID FROM ( ' + @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' inner join ('
					FROM @Tbl
					WHERE RowNum = @Counter1
				END
				ELSE
				BEGIN
					IF (@Counter1 = @RowCount1)
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID'
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
					ELSE
					BEGIN
						SELECT @Sql1 = @Sql1 + SQL + ') t' + CAST(@Counter1 AS VARCHAR) + ' on t' + CAST(@Counter1 AS VARCHAR) + '.ItemID=' + @tId + '.ItemID' + ' inner join ('
						FROM @Tbl
						WHERE RowNum = @Counter1
					END
				END

				SELECT @tId = 't' + CAST(@Counter1 AS VARCHAR);
			END

			SET @Counter1 = @Counter1 + 1
		END

		INSERT INTO @tblFinal
		EXEC (@Sql1)
	END;

	IF (@CategoryID IS NULL)
	BEGIN
		IF (@BrandID = 0)
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN dbo.Aspx_Currency c ON i.CurrencyCode = c.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.ViewCount DESC
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
		ELSE
		BEGIN
			IF (@RowTotal = 0)
				SELECT @RowTotal = count(i.ItemID)
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName;

			WITH TEST (
				IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
				)
			AS (
				SELECT (i.HasCostVariants) AS IsCostVariantItem
					,i.ItemID
					,i.AttributeSetID
					,i.ItemTypeID
					,i.HidePrice
					,i.HideInRSSFeed
					,i.HideToAnonymous
					,i.AddedOn
					,ii.[ImagePath] AS BaseImage
					,IMA.[AlternateText]
					,i.SKU
					,iid.[Name]
					,iid.ShortDescription
					,i.[Weight]
					,i.Quantity
					,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
					,i.IsFeatured
					,i.IsSpecial
					,ROW_NUMBER() OVER (
						ORDER BY i.ViewCount DESC
						) AS RowNumber
				FROM dbo.Aspx_items i
				INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
					AND c.StoreID = @StoreID
					AND c.PortalID = @PortalID
					AND c.IsDeleted = 0
					AND c.IsActive = 1
				INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
					AND bim.BrandID = @BrandID
				INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
				JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
				LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
					AND ii.ImageTypeID = 1
					AND ii.Isactive = 1
				LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
					AND IMA.CultureName = @CultureName
				WHERE (
						CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
							AND @PriceTo
						OR (
							@PriceFROM IS NULL
							AND @PriceTo IS NULL
							)
						)
					AND i.ItemTypeID != 4
					AND (
						iid.[Name] LIKE '%' + @SearchText + '%'
						OR iid.ShortDescription LIKE '%' + @SearchText + '%'
						)
					AND i.StoreID = @StoreID
					AND i.PortalID = @PortalID
					AND i.IsDeleted = 0
					AND i.IsActive = 1
					AND i.Visibility = 1
					AND ias.StoreID = @StoreID
					AND ias.PortalID = @PortalID
					AND ias.IsActive = 1
					AND ias.IsDeleted = 0
					AND (
						i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
						AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
						)
					AND (
						(
							i.HideToAnonymous = 0
							AND @UserName = 'anonymoususer'
							)
						OR @UserName != 'anonymoususer'
						)
					AND iid.CultureName = @CultureName
				)
			SELECT @RowTotal AS RowTotal
				,IsCostVariantItem
				,ItemID
				,AttributeSetID
				,ItemTypeID
				,HidePrice
				,HideInRSSFeed
				,HideToAnonymous
				,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
				,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
				,AddedOn
				,BaseImage
				,AlternateText
				,SKU
				,[Name]
				,ShortDescription
				,[Weight]
				,Quantity
				,ListPrice
				,IsFeatured
				,IsSpecial
				,RowNumber
			FROM Test
			WHERE RowNumber >= @offset
				AND RowNumber <= (@offset + @limit - 1)
		END
	END
	ELSE
	BEGIN
		IF (@IsGiftCard = 0)
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.ViewCount DESC
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
						AND CategoryID = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.ViewCount DESC
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
							AND CategoryID = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.ViewCount DESC
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
								AND CategoryID = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.ViewCount DESC
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN Aspx_ItemsCategories ic ON ic.ItemID = i.ItemID
									AND CategoryID = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
		ELSE
		BEGIN
			IF (
					@BrandID = 0
					AND @Attributes = ''
					)
			BEGIN
				IF (@RowTotal = 0)
					SELECT @RowTotal = count(i.ItemID)
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName;

				WITH TEST (
					IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
					)
				AS (
					SELECT (i.HasCostVariants) AS IsCostVariantItem
						,i.ItemID
						,i.AttributeSetID
						,i.ItemTypeID
						,i.HidePrice
						,i.HideInRSSFeed
						,i.HideToAnonymous
						,i.AddedOn
						,ii.[ImagePath] AS BaseImage
						,IMA.[AlternateText]
						,i.SKU
						,iid.[Name]
						,iid.ShortDescription
						,i.[Weight]
						,i.Quantity
						,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
						,i.IsFeatured
						,i.IsSpecial
						,ROW_NUMBER() OVER (
							ORDER BY i.ViewCount DESC
							) AS RowNumber
					FROM dbo.Aspx_items i
					INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
						AND c.StoreID = @StoreID
						AND c.PortalID = @PortalID
						AND c.IsDeleted = 0
						AND c.IsActive = 1
					INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
						AND GiftCardCategoryId = @CategoryID
					INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
					INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
					LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
						AND ii.ImageTypeID = 1
						AND ii.Isactive = 1
					LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
						AND IMA.CultureName = @CultureName
					WHERE (
							CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
								AND @PriceTo
							OR (
								@PriceFROM IS NULL
								AND @PriceTo IS NULL
								)
							)
						AND i.ItemTypeID != 4
						AND (
							iid.[Name] LIKE '%' + @SearchText + '%'
							OR iid.ShortDescription LIKE '%' + @SearchText + '%'
							)
						AND i.StoreID = @StoreID
						AND i.PortalID = @PortalID
						AND i.IsDeleted = 0
						AND i.IsActive = 1
						AND i.Visibility = 1
						AND ias.StoreID = @StoreID
						AND ias.PortalID = @PortalID
						AND ias.IsActive = 1
						AND ias.IsDeleted = 0
						AND (
							i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
							AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
							)
						AND (
							(
								i.HideToAnonymous = 0
								AND @UserName = 'anonymoususer'
								)
							OR @UserName != 'anonymoususer'
							)
						AND iid.CultureName = @CultureName
					)
				SELECT @RowTotal AS RowTotal
					,IsCostVariantItem
					,ItemID
					,AttributeSetID
					,ItemTypeID
					,HidePrice
					,HideInRSSFeed
					,HideToAnonymous
					,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
					,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
					,AddedOn
					,BaseImage
					,AlternateText
					,SKU
					,[Name]
					,ShortDescription
					,[Weight]
					,Quantity
					,ListPrice
					,IsFeatured
					,IsSpecial
					,RowNumber
				FROM Test
				WHERE RowNumber >= @offset
					AND RowNumber <= (@offset + @limit - 1)
			END
			ELSE
				IF (
						@BrandID <> 0
						AND @Attributes = ''
						)
				BEGIN
					IF (@RowTotal = 0)
						SELECT @RowTotal = count(i.ItemID)
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName;

					WITH TEST (
						IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
						)
					AS (
						SELECT (i.HasCostVariants) AS IsCostVariantItem
							,i.ItemID
							,i.AttributeSetID
							,i.ItemTypeID
							,i.HidePrice
							,i.HideInRSSFeed
							,i.HideToAnonymous
							,i.AddedOn
							,ii.[ImagePath] AS BaseImage
							,IMA.[AlternateText]
							,i.SKU
							,iid.[Name]
							,iid.ShortDescription
							,i.[Weight]
							,i.Quantity
							,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
							,i.IsFeatured
							,i.IsSpecial
							,ROW_NUMBER() OVER (
								ORDER BY i.ViewCount DESC
								) AS RowNumber
						FROM dbo.Aspx_items i
						INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
							AND c.StoreID = @StoreID
							AND c.PortalID = @PortalID
							AND c.IsDeleted = 0
							AND c.IsActive = 1
						INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
							AND GiftCardCategoryId = @CategoryID
						INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
						INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
							AND bim.BrandID = @BrandID
						INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
						LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
							AND ii.ImageTypeID = 1
							AND ii.Isactive = 1
						LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
							AND IMA.CultureName = @CultureName
						WHERE (
								CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
									AND @PriceTo
								OR (
									@PriceFROM IS NULL
									AND @PriceTo IS NULL
									)
								)
							AND i.ItemTypeID != 4
							AND (
								iid.[Name] LIKE '%' + @SearchText + '%'
								OR iid.ShortDescription LIKE '%' + @SearchText + '%'
								)
							AND i.StoreID = @StoreID
							AND i.PortalID = @PortalID
							AND i.IsDeleted = 0
							AND i.IsActive = 1
							AND i.Visibility = 1
							AND ias.StoreID = @StoreID
							AND ias.PortalID = @PortalID
							AND ias.IsActive = 1
							AND ias.IsDeleted = 0
							AND (
								i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
								AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
								)
							AND (
								(
									i.HideToAnonymous = 0
									AND @UserName = 'anonymoususer'
									)
								OR @UserName != 'anonymoususer'
								)
							AND iid.CultureName = @CultureName
						)
					SELECT @RowTotal AS RowTotal
						,IsCostVariantItem
						,ItemID
						,AttributeSetID
						,ItemTypeID
						,HidePrice
						,HideInRSSFeed
						,HideToAnonymous
						,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
						,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
						,AddedOn
						,BaseImage
						,AlternateText
						,SKU
						,[Name]
						,ShortDescription
						,[Weight]
						,Quantity
						,ListPrice
						,IsFeatured
						,IsSpecial
						,RowNumber
					FROM Test
					WHERE RowNumber >= @offset
						AND RowNumber <= (@offset + @limit - 1)
				END
				ELSE
					IF (
							@BrandID = 0
							AND @Attributes != ''
							)
					BEGIN
						IF (@RowTotal = 0)
							SELECT @RowTotal = count(i.ItemID)
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName;

						WITH TEST (
							IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
							)
						AS (
							SELECT (i.HasCostVariants) AS IsCostVariantItem
								,i.ItemID
								,i.AttributeSetID
								,i.ItemTypeID
								,i.HidePrice
								,i.HideInRSSFeed
								,i.HideToAnonymous
								,i.AddedOn
								,ii.[ImagePath] AS BaseImage
								,IMA.[AlternateText]
								,i.SKU
								,iid.[Name]
								,iid.ShortDescription
								,i.[Weight]
								,i.Quantity
								,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
								,i.IsFeatured
								,i.IsSpecial
								,ROW_NUMBER() OVER (
									ORDER BY i.ViewCount DESC
									) AS RowNumber
							FROM dbo.Aspx_items i
							INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
								AND c.StoreID = @StoreID
								AND c.PortalID = @PortalID
								AND c.IsDeleted = 0
								AND c.IsActive = 1
							INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
								AND GiftCardCategoryId = @CategoryID
							INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
							INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
							INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
							LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
								AND ii.ImageTypeID = 1
								AND ii.Isactive = 1
							LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
								AND IMA.CultureName = @CultureName
							WHERE (
									CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
										AND @PriceTo
									OR (
										@PriceFROM IS NULL
										AND @PriceTo IS NULL
										)
									)
								AND i.ItemTypeID != 4
								AND (
									iid.[Name] LIKE '%' + @SearchText + '%'
									OR iid.ShortDescription LIKE '%' + @SearchText + '%'
									)
								AND i.StoreID = @StoreID
								AND i.PortalID = @PortalID
								AND i.IsDeleted = 0
								AND i.IsActive = 1
								AND i.Visibility = 1
								AND ias.StoreID = @StoreID
								AND ias.PortalID = @PortalID
								AND ias.IsActive = 1
								AND ias.IsDeleted = 0
								AND (
									i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
									AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
									)
								AND (
									(
										i.HideToAnonymous = 0
										AND @UserName = 'anonymoususer'
										)
									OR @UserName != 'anonymoususer'
									)
								AND iid.CultureName = @CultureName
							)
						SELECT @RowTotal AS RowTotal
							,IsCostVariantItem
							,ItemID
							,AttributeSetID
							,ItemTypeID
							,HidePrice
							,HideInRSSFeed
							,HideToAnonymous
							,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
							,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
							,AddedOn
							,BaseImage
							,AlternateText
							,SKU
							,[Name]
							,ShortDescription
							,[Weight]
							,Quantity
							,ListPrice
							,IsFeatured
							,IsSpecial
							,RowNumber
						FROM Test
						WHERE RowNumber >= @offset
							AND RowNumber <= (@offset + @limit - 1)
					END
					ELSE
						IF (
								@BrandID <> 0
								AND @Attributes != ''
								)
						BEGIN
							IF (@RowTotal = 0)
								SELECT @RowTotal = count(i.ItemID)
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName;

							WITH TEST (
								IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
								)
							AS (
								SELECT (i.HasCostVariants) AS IsCostVariantItem
									,i.ItemID
									,i.AttributeSetID
									,i.ItemTypeID
									,i.HidePrice
									,i.HideInRSSFeed
									,i.HideToAnonymous
									,i.AddedOn
									,ii.[ImagePath] AS BaseImage
									,IMA.[AlternateText]
									,i.SKU
									,iid.[Name]
									,iid.ShortDescription
									,i.[Weight]
									,i.Quantity
									,CAST((i.ListPrice / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) AS ListPrice
									,i.IsFeatured
									,i.IsSpecial
									,ROW_NUMBER() OVER (
										ORDER BY i.ViewCount DESC
										) AS RowNumber
								FROM dbo.Aspx_items i
								INNER JOIN [dbo].[Aspx_Currency] c ON c.CurrencyCode = i.CurrencyCode
									AND c.StoreID = @StoreID
									AND c.PortalID = @PortalID
									AND c.IsDeleted = 0
									AND c.IsActive = 1
								INNER JOIN [dbo].[Aspx_GiftCardItemCategory] ic ON i.ItemID = ic.ItemID
									AND GiftCardCategoryId = @CategoryID
								INNER JOIN [dbo].[Aspx_ItemInformationDetails] iid ON iid.ItemID = i.ItemID
								INNER JOIN [dbo].[Aspx_BrandItemMapping] bim ON bim.ItemID = i.ItemID
									AND bim.BrandID = @BrandID
								INNER JOIN @tblFinal tf ON tf.ItemID = i.ItemID
								INNER JOIN dbo.Aspx_AttributeSet ias ON i.AttributeSetID = ias.AttributeSetID
								LEFT JOIN [dbo].[Aspx_ItemImages] ii ON i.ItemID = ii.ItemID
									AND ii.ImageTypeID = 1
									AND ii.Isactive = 1
								LEFT JOIN [dbo].[Aspx_ItemImagesAlias] IMA ON IMA.ItemImageID = ii.ItemImageID
									AND IMA.CultureName = @CultureName
								WHERE (
										CAST((i.Price / ISNULL(c.ConversionRate, 1)) AS DECIMAL(16, 4)) BETWEEN @PriceFrom
											AND @PriceTo
										OR (
											@PriceFROM IS NULL
											AND @PriceTo IS NULL
											)
										)
									AND i.ItemTypeID != 4
									AND (
										iid.[Name] LIKE '%' + @SearchText + '%'
										OR iid.ShortDescription LIKE '%' + @SearchText + '%'
										)
									AND i.StoreID = @StoreID
									AND i.PortalID = @PortalID
									AND i.IsDeleted = 0
									AND i.IsActive = 1
									AND i.Visibility = 1
									AND ias.StoreID = @StoreID
									AND ias.PortalID = @PortalID
									AND ias.IsActive = 1
									AND ias.IsDeleted = 0
									AND (
										i.ActiveFrom <= convert(VARCHAR(10), getdate(), 111)
										AND i.ActiveTo >= convert(VARCHAR(10), getdate(), 111)
										)
									AND (
										(
											i.HideToAnonymous = 0
											AND @UserName = 'anonymoususer'
											)
										OR @UserName != 'anonymoususer'
										)
									AND iid.CultureName = @CultureName
								)
							SELECT @RowTotal AS RowTotal
								,IsCostVariantItem
								,ItemID
								,AttributeSetID
								,ItemTypeID
								,HidePrice
								,HideInRSSFeed
								,HideToAnonymous
								,[dbo].[ufn_CheckOutOfStock](ItemID, @StoreID, @PortalID) AS IsOutOfStock
								,dbo.[ufn_CatalogPriceRule](ItemID, @StoreID, @PortalID, @UserName, @CultureName) AS Price
								,AddedOn
								,BaseImage
								,AlternateText
								,SKU
								,[Name]
								,ShortDescription
								,[Weight]
								,Quantity
								,ListPrice
								,IsFeatured
								,IsSpecial
								,RowNumber
							FROM Test
							WHERE RowNumber >= @offset
								AND RowNumber <= (@offset + @limit - 1)
						END
		END
	END
END

GO